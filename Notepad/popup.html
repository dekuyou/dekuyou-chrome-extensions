<html>
<head>
<title>pop Notepad</title>
<link rel = "stylesheet" href = "EdgeToEdge.css" /> 	
<style type="text/css">
.rtop, .rbottom{display:block; background: #FFF}
.rtop *, .rbottom *{display: block; height: 1px; overflow: hidden; background-color: #eeeecc;}
.r1{margin: 0 5px}
.r2{margin: 0 3px}
.r3{margin: 0 2px}
.r4{margin: 0 1px; height: 2px}
</style>
<script>

var background = chrome.extension.getBackgroundPage();

var text="";

var nowpage=(localStorage["nowpage"] || "1");


window.addEventListener('load', function(e) {
	init();
	
	checkAreasize();
	
	getSelectedText();
	
	document.getElementById("byte").innerHTML = countByte((localStorage["notepad"+nowpage] || ""));

	background.badge(nowpage);
	document.getElementById("pageno").innerHTML = nowpage;
	
}, false);

function console(){
	console.log('test:' + text);
	background.foo();

}



window.addEventListener('keyup', function(e) {
	update();
	
	checkAreasize();
}, false);

window.addEventListener('keydown', function(e) {
	
	checkAreasize();
}, false);

function getSelectedText(){
	chrome.tabs.getSelected(null, function(tab){
        chrome.tabs.sendRequest(tab.id, {selected:true}, function(res){
			text = (res.text || "");
			document.getElementById("rtxt").value = document.getElementById("rtxt").value +text;
			update();
			checkAreasize();
			

		});
	});
}

function init(){
	document.getElementById("rtxt").value = ( localStorage["notepad"+nowpage] || "" )+"";
}

function update(){
	localStorage["notepad"+nowpage] = document.getElementById("rtxt").value ;
	
	document.getElementById("byte").innerHTML = countByte((localStorage["notepad"+nowpage] || ""));

}

function checkAreasize(){ 
	tval = document.getElementById("rtxt").value;
	num = tval.match(/\n/g);   //
	rnum = tval.split(/\n/g);
	var retu =40;
	var gyosuu = 10;
	if(tval==""){
		return;
	}
	for(i=0;i < rnum.length;i = i +1){
		if (retu < countByte(rnum[i])){
			retu = countByte(rnum[i]);
		}
	}

	if(num!=null){
		

		
		gyosuu = num.length +2;
		if(gyosuu < 10){
			gyosuu = 10;
		}
	}
	
	document.getElementById("rtxt").cols = retu;
	document.getElementById("rtxt").rows = gyosuu;

}


function countByte(str) {
    var count = 0;
    for(var i = 0; i < str.length; i++) {
       if (escape(str.charAt(i)).length < 4) {
          count++;
       }
       else {
          count += 2;
       }
    }
    return count;
}

function nextPage(){
	update();


	if((nowpage-0) <999){
		nowpage = localStorage["nowpage"] = nowpage -0 + 1;
	}else{
		nowpage = localStorage["nowpage"] = 1;
	}
	init();
	checkAreasize();	
	document.getElementById("byte").innerHTML = countByte((localStorage["notepad"+nowpage] || ""));
	
	document.getElementById("pageno").innerHTML = nowpage;
	background.badge(nowpage);

}

function prevPage(){
	update();

	if((nowpage-0) >1){
		nowpage = localStorage["nowpage"] = nowpage -0 - 1;
	}else{
		nowpage = localStorage["nowpage"] = 999;
	}
	init();
	checkAreasize();
	document.getElementById("byte").innerHTML = countByte((localStorage["notepad"+nowpage] || ""));
	
	document.getElementById("pageno").innerHTML = nowpage;

	background.badge(nowpage);

}

function viewStatus(str1,str2){
    //
    var status = document.getElementById(str1);
    status.innerHTML = str2;
    setTimeout(function() { status.innerHTML = ""; }, 3 * 1000);


}


function twitter(){
	//loadinfo.net.gif
	document.getElementById("status").innerHTML ="<img src=loadinfo.net.gif label='updateing.'>";

//	if(countByte((localStorage["notepad"+nowpage] || "")) > 140){
//		viewStatus("status","Over 140byte.");
//		return;
//	}
//	if((localStorage["twitterid"] || "") == ""){
		background.twitter(nowpage);
//	}else{
//		document.getElementById("popupBody").innerHTML ='<a href=# onclick=background.twitter(nowpage);doT();>Post</a> &nbsp; <span onClick=cancelT();>cancel</span>';
//		popup('comment');
		
//	}

}


function doT(){
		viewStatus("status","");
		popdown('comment');
}
function cancelT(){
		viewStatus("status","cancel.");
		popdown('comment');
}


function gmail(){
//a/bsweb.office-on-the.net mail
	var domain;
	if(localStorage["appsdomain"]){
		domain="a/"+localStorage["appsdomain"];
	}else{
		domain="mail"
	}
	
	var rnum = (localStorage["notepad"+nowpage] || "").split(/\n/g);
	var su = rnum[0];
	
	var url = 'https://mail.google.com/'+ domain +'/?view=cm&fs=1&tf=1&su='+encodeURIComponent(su)+'&source=mailto&body='+encodeURIComponent((localStorage["notepad"+nowpage] || ""))

	if(countByte(url) > 2000){
		viewStatus("status","Text is too long.");
		return;
	}

	background.gmail(nowpage);
	
	
}


function gCalendar(){

	background.gCalendar(nowpage);
	
	
}

function copy(){
	viewStatus("status","Copy to ClipBoard.");

}

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
        if (request.status==200){
			viewStatus("status","posted.");
		}else if(request.status==404){
			viewStatus("status","failed.");
		}
});






function popup( id) {
    var elm = document.getElementById(id);
    elm.style.display='block';
    elm.style.position='absolute';

	elm.style.left = (event.pageX -35) + "px";

    elm.style.top = (event.pageY -40) + "px";
}

function popdown(id) {
    document.getElementById(id).style.display='none';
}


function postMail(){
	document.getElementById("status").innerHTML ="<img src=loadinfo.net.gif label='updateing.'>";

	var rnum = (localStorage["notepad"+nowpage] || "").split(/\n/g);
	var su = rnum[0];
	var url = 'mailto:?subject='+encodeURIComponent(su)+'&body='+encodeURIComponent((localStorage["notepad"+nowpage] || ""));



	document.getElementById("popupBody").innerHTML ='<a href="'+url+'" target=_blank onclick=doT();>Send</a> &nbsp; <span onClick=cancelT();>cancel</span>';
	popup('comment');
	
	}

function remove(){
	document.getElementById("status").innerHTML ="<img src=loadinfo.net.gif label='updateing.'>";

	document.getElementById("popupBody").innerHTML ='<a href=# onclick=doRemove();>delet</a> &nbsp; <span onClick=cancelT();>cancel</span>';
	popup('comment');

}

function doRemove(){
	viewStatus("status","Delete.");
	localStorage.removeItem("notepad"+nowpage);
	
	init();
	checkAreasize();
	
	document.getElementById("byte").innerHTML = countByte((localStorage["notepad"+nowpage] || ""));

	popdown('comment');
}


function doNotepad(setpage){
	nowpage = localStorage["nowpage"] = setpage;
	showNotepad();
	init();
	checkAreasize();
	
	document.getElementById("byte").innerHTML = countByte((localStorage["notepad"+nowpage] || ""));
	
		document.getElementById("pageno").innerHTML = nowpage;
			background.badge(nowpage);

}

function showNotepad(){
	document.getElementById('notearea').style.display='inline';
	document.getElementById('menuarea').style.display='none';
}


function doMenu(){
	document.getElementById('notearea').style.display='none';
	document.getElementById('menuarea').style.display='inline';
	var str="";
	var newnote = true;
	var retu=0;
	for(i=1;i <1000;i = i +1){
		rtxt=(localStorage["notepad" + i] || "");
		if(rtxt.length > 0){
			rnum = rtxt.split(/\n/g);
			str = str + '<li><a href=# onClick="doNotepad('+i+');">P.'+i+'<span class="secondaryWLink" style="width: 220px; white-space: nowrap; overflow: hidden; text-overflow: clip;">'+htmlEscape(rnum[0])+'</span></a></li>';
			retu = retu +1;
		}else{
			if(newnote){
				str = str + '<li><a href=# onClick="doNotepad('+i+');">P.'+i+'<span class="secondaryWLink" >New Note.</span></a></li>';
				newnote = false;
				retu =retu +1;
			}
		
		}
	}
	
	str=str+'<li><a href=options.html target=_blank>&nbsp;<span class="secondaryWLink" >About popNotepad</span></a></li>';
	

	
	document.getElementById('menuline').innerHTML = str;
	
	window.location.hash = "menuline";
	
}
function doSearch(){
	document.getElementById('notearea').style.display='none';
	document.getElementById('menuarea').style.display='inline';
	var str='<li><a href=# onClick="doMenu();"><img src=la.png label="prev."><span class="secondaryWLink" >back Menu.</span></a></li>';
	
	for(i=1;i <1000;i = i +1){
		rtxt=(localStorage["notepad" + i] || "");
		if(rtxt.indexOf(document.getElementById('searchtext').value) >= 0){
			if(rtxt.length > 0){
				rnum = rtxt.split(/\n/g);
				str = str + '<li><a href=# onClick="doNotepad('+i+');">P.'+i+'<span class="secondaryWLink" style="width: 220px; white-space: nowrap; overflow: hidden; text-overflow: clip;">'+htmlEscape(rnum[0])+'</span></a></li>';
			}
		}
	}
	
	
	document.getElementById('menuline').innerHTML = str;
	
	window.location.hash = "menuline";
	
}
var htmlEscape = (function(){
  var map = {"<":"&lt;", ">":"&gt;", "&":"&amp;", "'":"&#39;", "\"":"&quot;", " ":"&nbsp;"};
  var replaceStr = function(s){ return map[s]; };
  return function(str) { return str.replace(/<|>|&|'|"|\s/g, replaceStr); };
})();

</script>
</head>
<body>


<div id="notearea" style="width: 100%">
<table height=5px cellpadding="0" cellspacing="0" style="width: 100%">
	<tr>
		<td align=left width=10% >Page.<span id=pageno></span></td>
		<td align=center >&nbsp;<span id=status></span>&nbsp;</td>
		<td align=right width=10% ><span onClick="update();doMenu();">index</span></td>
	</tr>
</table>

<table>
	<tr >
		<td colspan=4>
			<textarea name="popnote" id=rtxt rows="10" cols="40" style="overflow:hidden;"></textarea>
		</td>
	</tr>
</table>

<table height=5px cellpadding="0" cellspacing="3" style="width: 100%">
	<tr>
		<td align=left width=10% ><span id=prevpage onClick=prevPage()><img src=la.png label='prev.'></span></td>
		<td align=left width=50%>&nbsp;&nbsp;
			<span id=twitter onClick=twitter();><img src=twitter.png label='update Twitter.'></span>
			<span id=mail onClick=postMail();><img src=mail.png label='send from mail.'></span>
			<span id=gmail onClick=gmail();><img src=gmail.png label='send from gmail.'></span>
			<span id=gCalendar onClick=gCalendar();><img src=goggle-calendar.png label='add to Google Calendar.'></span>
		</td>
		<td align=right width=30%>
			<span id=rm onClick=remove();><img src=rm.png label='remove.'></span>
			<span id=byte></span>
			&nbsp;</td>
		<td align=right width=10% ><span id=nextpage onClick=nextPage();><img src=ra.png label='next.'></span></td>
	</tr>
</table>
</div>

<div id="menuarea"  style="width: 100%; display: none; ">


<div style="text-align: center;">
<table style="width: 325px;">
	<tr><td>
	<input type=text size=30 id=searchtext><button onClick=doSearch();>Search</button>
	</td></tr>
</table>
</div>
<li>
	<div id="menuline">

	
	</div>
</li>
</div>



<div id="comment" style="display: none; background-color: #eeeecc; width: 100px;　height 10px; position: absolute; top: 0; left: 0;">
<b class="rtop">
  <b class="r1"></b> <b class="r2"></b> <b class="r3"></b> <b class="r4"></b>
</b>
<div style="margin: 1px 0 1px 0; width: 100%; text-align: center;" id=popupBody></div>
<b class="rbottom">
  <b class="r4"></b> <b class="r3"></b> <b class="r2"></b> <b class="r1"></b>
</b>
</div>




</body> 
</html>

